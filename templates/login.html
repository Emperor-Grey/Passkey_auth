{% extends "base.html" %} {% block title %}Login - Passkey Auth{% endblock %} {%
block content %}
<div
  class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full space-y-8">
    <div>
      <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
        Sign in to your account
      </h2>
      <p class="mt-2 text-center text-sm text-gray-600">
        Use your passkey to sign in securely
      </p>
    </div>
    <form id="login-form" class="mt-8 space-y-6">
      <div class="rounded-md shadow-sm -space-y-px">
        <div>
          <label for="username" class="sr-only">Username</label>
          <input
            id="username"
            name="username"
            type="text"
            required
            class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm"
            placeholder="Username"
          />
        </div>
      </div>

      <div>
        <button
          type="submit"
          class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
        >
          Sign in with Passkey
        </button>
      </div>

      <p class="text-center text-sm text-gray-600">
        Don't have a passkey?
        <a href="/register" class="text-primary">Register</a>
      </p>
    </form>
    <div
      id="error-message"
      class="mt-2 text-center text-sm text-red-600 hidden"
    ></div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document
    .getElementById("login-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const errorMessage = document.getElementById("error-message");

      try {
        console.log("Starting authentication for user:", username);

        // Get authentication options
        const optionsResponse = await fetch("/login/begin", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username,
            origin: window.location.origin,
          }),
        });

        if (!optionsResponse.ok) {
          const error = await optionsResponse.json();
          throw new Error(error.message || "Failed to start authentication");
        }

        const optionsData = await optionsResponse.json();
        console.log("Received authentication options:", optionsData);

        // Format the options for WebAuthn API
        const publicKeyCredentialRequestOptions = {
          challenge: base64ToArrayBuffer(optionsData.publicKey.challenge),
          allowCredentials: optionsData.publicKey.allowCredentials.map(
            (credential) => ({
              id: base64ToArrayBuffer(credential.id),
              type: "public-key",
              transports: credential.transports || ["internal"],
            })
          ),
          timeout: optionsData.publicKey.timeout || 60000,
          rpId: optionsData.publicKey.rpId,
          userVerification:
            optionsData.publicKey.userVerification || "preferred",
        };

        console.log(
          "Requesting credential with options:",
          publicKeyCredentialRequestOptions
        );

        // Get credential from authenticator
        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions,
        });

        console.log("Received assertion from authenticator:", assertion);

        // Complete authentication
        const completeResponse = await fetch("/login/complete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username,
            credential: {
              id: assertion.id,
              rawId: arrayBufferToBase64(assertion.rawId),
              type: assertion.type,
              response: {
                authenticatorData: arrayBufferToBase64(
                  assertion.response.authenticatorData
                ),
                clientDataJSON: arrayBufferToBase64(
                  assertion.response.clientDataJSON
                ),
                signature: arrayBufferToBase64(assertion.response.signature),
                userHandle: assertion.response.userHandle
                  ? arrayBufferToBase64(assertion.response.userHandle)
                  : null,
              },
            },
            origin: window.location.origin,
          }),
        });

        if (!completeResponse.ok) {
          const error = await completeResponse.text();
          throw new Error(error.message || "Authentication failed");
        }

        // Since we're getting HTML back, redirect to the response URL
        window.location.href = completeResponse.url;
      } catch (error) {
        console.error("Authentication error:", error);
        errorMessage.textContent = error.message;
        errorMessage.classList.remove("hidden");
      }
    });

  // Utility functions for base64url conversion
  function base64ToArrayBuffer(base64url) {
    if (!base64url) {
      throw new Error("base64url string is required");
    }
    const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/");
    const padding = "=".repeat((4 - (base64.length % 4)) % 4);
    const normalizedBase64 = base64 + padding;

    const binaryString = window.atob(normalizedBase64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    const base64 = window.btoa(binary);
    return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
  }
</script>
{% endblock %}
